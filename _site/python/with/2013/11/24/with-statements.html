<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Python 的 with 声明</title>
        <meta name="viewport" content="width=device-width" />

        <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css" />
        
        <!-- RSS -->
        <link rel="alternate" type="application/rss+xml" title="Tonsh's Blog" href="http://tonsh.github.io/feed.xml" />

    </head>

    <body>
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Tonsh's Blog</a></h1>
</div>

<!--<div class="nav">
  <div class="nav-block">
      <a class="item" href="/">Home</a>
  </div>
</div>
-->

<div class="site-content">
<h2 class="post-title">Python 的 with 声明</h2>
<p class="meta">24 Nov 2013</p>

<div class="post">
<div class="highlight"><pre><code class="python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">line</span>
</code></pre></div>

<p>以上代码实现了打印目标文档的内容。 这里的 with 声明等价于：</p>

<div class="highlight"><pre><code class="python"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">line</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p>若忘记了关闭打开的文档，或者在读取过程中遇到异常导致没有关闭文档怎么办，可能我们还会做如下处理：</p>

<div class="highlight"><pre><code class="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">line</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p>无论如何我们需要保证程序结束时能关闭文档。这时候就体现了 with 语法的优势，使用 with 声明会自动处理清理操作（如 关闭文档，释放数据库连接，对象销毁等）。</p>

<h4>with 声明是如何工作的呢？</h4>

<p>一个对象如果想使用 with 声明，对象类必须实现 <code>__enter__</code>, <code>__exit__</code> 两个魔术方法。跟在 with 后的对象初始化后，会调用 <code>__enter__</code> 方法。</p>

<p>我们来看看 BufferedReader 的 Python 源代码是如何实现这两个魔术方法的。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">注：
open() returns a file object whose type depends on the mode, … … in read binary mode, it returns a **BufferedReader**; in write binary and append binary modes, it returns a **BufferedWriter**, and in read/write mode, it returns a **BufferedRandom.**

Python 的内置方法 open() 会根据第二个参数 mode 返回不同的文件对象. 如 mode=&#39;r&#39;, 则返回 BufferedReader 类。
</code></pre></div>
<p>Python-2.7.4/Lib/_pyio.py  代码顺序做了调整</p>

<div class="highlight"><pre><code class="python"><span class="c"># 根据继承关系找下去</span>
<span class="k">class</span> <span class="nc">BufferedReader</span><span class="p">(</span><span class="n">_BufferedIOMixin</span><span class="p">):</span>
    <span class="c"># blablabla ...</span>
    
<span class="k">class</span> <span class="nc">_BufferedIOMixin</span><span class="p">(</span><span class="n">BufferedIOBase</span><span class="p">):</span>
    <span class="c"># blablabla ...</span>
    
<span class="k">class</span> <span class="nc">BufferedIOBase</span><span class="p">(</span><span class="n">IOBase</span><span class="p">):</span>
    <span class="c"># blablabla ...</span>
    
<span class="k">class</span> <span class="nc">IOBase</span><span class="p">:</span>
    <span class="c"># blablabla ...</span>

    <span class="n">__closed</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;closed: bool.  True iff the file has been closed. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span>

    <span class="c"># 检查文档是否关闭</span>
    <span class="k">def</span> <span class="nf">_checkClosed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal: raise an ValueError if file is closed&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;I/O operation on closed file.&quot;</span>
                             <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">msg</span><span class="p">)</span>
                             
    
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush write buffers, if applicable. This is not implemented for read-only and non-blocking streams.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkClosed</span><span class="p">()</span>
        

    <span class="c"># 我们调用的 f.close() 就是这个</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flush and close the IO object.This method has no effect if the file is already closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__closed</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># 检查文件是否能打开，self.closed 初始值为 False</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkClosed</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p>with open(&#39;demo.txt&#39;, &#39;r&#39;) as f, 文件对象 f 一旦创建，就会执行 f.<code>__enter__</code>() 方法, 当跳出 with 声明时，会执行 f.<code>__exit__</code>() 方法，关闭文件。</p>

<p>到这里我们知道了一般在需要 try ... finally ... 的时候会选择使用 with 声明； with 声明的对象类必须实现 <code>__enter__</code>, <code>__exit__</code> 两个方法; </p>

<p>想到一个例子，公司厕所里贴着: &quot;上完厕所要冲厕!&quot; 的标语。 那么我们实现一个高端大气上档次的自动冲厕功能好了 &gt;_&lt;！［大汗］</p>

<div class="highlight"><pre><code class="python"><span class="k">class</span> <span class="nc">AutoFlushing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># 厕所初始情况下是干净的</span>
    <span class="n">_flushed</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">have_a_piss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 自行YY吧</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 冲水完毕</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flushed</span> <span class="o">=</span> <span class="bp">True</span>
        
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flushed</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
<span class="c"># 小萌来上厕所，会自动冲水的哦！</span>
<span class="k">with</span> <span class="n">AutoFlushing</span><span class="p">()</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
    <span class="n">fl</span><span class="o">.</span><span class="n">have_a_piss</span><span class="p">()</span>
</code></pre></div>

<p>至此写完，节操掉一地，掩面逃走！</p>

</div>

<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"tonsh"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->

</div>


        <div class="footer">
          <p>
            &copy; 2013 - 2013 tonsh&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/about">About</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/links">Links</a>&nbsp;&nbsp;|&nbsp;&nbsp;Powered by <a href="http://github.com/mojombo/jekyll" target="_blank">Jekyll</a>&<a href="http://pages.github.com" target="_blank">GitHub</a>
          </p>
        </div>
      </div>
    </body>
</html>
