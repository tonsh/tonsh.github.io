<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Python 的日志模块</title>
        <meta name="viewport" content="width=device-width" />

        <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css" />
        
        <!-- RSS -->
        <link rel="alternate" type="application/rss+xml" title="Tonsh's Blog" href="http://tonsh.github.io/feed.xml" />

    </head>

    <body>
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Tonsh's Blog</a></h1>
</div>

<!--<div class="nav">
  <div class="nav-block">
      <a class="item" href="/">Home</a>
  </div>
</div>
-->

<div class="site-content">
<h2 class="post-title">Python 的日志模块</h2>
<p class="meta">27 Nov 2013</p>

<div class="post">
<p>平时调试程序时习惯使用 print 打印调试信息，通过之后再把它们删掉。如:</p>

<div class="highlight"><pre><code class="python"><span class="k">print</span> <span class="s">&#39;server start ...&#39;</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">print</span> <span class="s">&#39;do something ...&#39;</span>
<span class="n">s</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>

<span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;server stop ...&#39;</span>
</code></pre></div>

<p>在一些简单的调试程序中可以这样做，但如果是在生产环境或者一个很复杂的项目里最好不要这样做。首先，这些调试信息无法被灵活保存在日志里，即使被保存了，也很难在日志看到更详细的信息，如错误级别，时间，出错地点等等。 在项目中记录日志是很重要的。倘若有一天顾客向你反馈问题，这时候首先想到的应该是去查看日志信息了解到底发生了什么错误，前提是你的日志记录很完善。</p>

<p>Pyhton 标准库提供了灵活易用的 logging 模块。一般用法如下：</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(name)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;This is a error message !!&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;This is a Warning message!&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;This is an info message!&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;This is a debug message !&#39;</span><span class="p">)</span>
</code></pre></div>

<p>输出结果如下:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">2013-11-27 18:48:42,591 __main__ ERROR This is a error message !! 
</code></pre></div>
<p>basicConfig 可以配置日志的输出格式，日志级别，目标输出流等等。日志级别可参考<a href="http://docs.python.org/2/library/logging.html" target="_blank">手册</a>, 低于日志级别的消息将被忽略。如将上例中的日志级别改为 logging.EBUG，输出结果如下：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">2013-11-27 18:49:43,659 __main__ ERROR This is a error message !!
2013-11-27 18:49:43,658 __main__ WARNING This is a Warning message!
2013-11-27 18:49:43,658 __main__ INFO This is an info message!
2013-11-27 18:49:43,658 __main__ DEBUG This is a debug message !
</code></pre></div>
<p>logger 默认将日志内容输出到终端。还可以输出到文件，发送到邮箱或远程服务器等，这里不做详细介绍，可以参考<a href="http://docs.python.org/2/library/logging.handlers.html#module-logging.handlers" target="_blank">Python 手册</a>。下面以文件为例:</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c"># create a file handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s">&#39;./output.log&#39;</span><span class="p">)</span>
<span class="c"># 如果没有设置handler的日志级别，会使用 logger 的日志级别</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(name)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span> 
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> 
<span class="c"># add the handler to logger</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span> 
 
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;This is an info message!&#39;</span><span class="p">)</span> 
<span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;This is a debug message !&#39;</span><span class="p">)</span> 
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;This is a Warning message!&#39;</span><span class="p">)</span> 
<span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;This is a error message !!&#39;</span><span class="p">)</span> 
</code></pre></div>

<p>output.log</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">2013-11-27 18:49:43,659 __main__ ERROR This is a error message !!
</code></pre></div>
<p><b>日志级别的使用习惯</b></p>

<p>以下为我自己理解的使用习惯，仅供参考:</p>

<p>debug: 用于需要记录调试信息的地方，如循环体内计数</p>

<div class="highlight"><pre><code class="python"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;number: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="c"># do something with for-loop</span>
</code></pre></div>

<p>Info: 用于记录运行状态等</p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">demo</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;demo method start ...&#39;</span><span class="p">)</span>
    <span class="c"># do something</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;demo method end ...&#39;</span><span class="p">)</span>
</code></pre></div>

<p>warning: 用于逻辑异常但不是错误时</p>

<div class="highlight"><pre><code class="python"><span class="k">if</span> <span class="n">pwd</span> <span class="o">!=</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Login password error&#39;</span><span class="p">)</span>
</code></pre></div>

<p>error: 当遇到错误时</p>

<div class="highlight"><pre><code class="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>

<p><b>记录异常</b></p>

<p>当程序抛出异常时，我们更希望将所有的异常信息写进日志，方便查看具体的出错信息。这时可以设置 logger 的 exc_info 参数为 True, logger 将会记录完整的异常信息。</p>

<div class="highlight"><pre><code class="python"><span class="k">try</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;have a exception: &#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div>

<p>输入如下:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">2013-11-27 20:23:42,092 __main__ ERROR have a exception:
Traceback (most recent call last):
  File &quot;mylog.py&quot;, line 26, in &lt;module&gt;
    a = 1 / 0
ZeroDivisionError: integer division or modulo by zero 
</code></pre></div>
<p><b>切分日志文件 (Rotating file handler)</b></p>

<p>使用 FileHandler 写日志，日志文件会一直增长下去。也许某天它会占满你的磁盘。为了避免这种情况，建议使用 RotatingFileHandler 代替 FileHandler。</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="c"># create rotating file handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">RotatingFileHandler</span><span class="p">(</span><span class="s">&#39;output.log&#39;</span><span class="p">,</span>
                                                <span class="n">maxBytes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                                <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> </span><span class="si">%(name)s</span><span class="s"> </span><span class="si">%(levelname)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span> 
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> 
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;num: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</code></pre></div>

<p>最后生成 6 个 output 文件，日志信息分别存放在 6 个文件里。backupCount 为最多保留的日志文件数，超出这些数量的文档将不会被保留。所以如果 backupCount=6 则最多能生成 7 个日志文件。(文件数 = backupCount + 1)</p>

<p><b>logger 的名字</b></p>

<p>以上的例子都是使用 <code>__name__</code> 作为 logger 的 name 参数。Python 的 <code>__name__</code> 是当前包的名字。在foo.bar.mylog文件里调用logging.getLogger(<code>__name__</code>)等价于logging.getLogger(&#39;foo.bar.mylog&#39;)。&quot;foo.bar.mylog&quot;, &quot;foo.bar&quot; 都是 &quot;foo&quot; 的子级，子级会继承父级的配置。</p>

<p><b>logger 的配置文件</b></p>

<p>截至到这里，我们都是在程序中直接对 logger 进行配置，其实配置 logger 最好使用logging.config。配置可以是字典，由 dictConfig 解析, 也可以是文件，由 fileConfig 解析，fileConfig 基于 ConfigParser 格式。配置必须包含 loggers, heandlers, formatters 三个部分。<a href="http://docs.python.org/2/library/logging.config.html" target="_blank">参考手册</a></p>

<p>假设在 logger 部分定义了一个个名为 &quot;foo&quot; 的 logger, 那么就要同时定义一个名为 [logger_foo]的部分；<code>[handlers], [handler_foo], [formatters], [formatter_foo]</code> 也都要有对 foo 的定义。下面以三个名为 &quot;root&quot;, &quot;foo&quot;, &quot;bar&quot; 的 logger 为例,这里需要了解 root 是 logger 的默认名字。配置 root 输出到终端, foo 输出到文件，bar 输出到切分文件，它们的输出格式，日志级别等可以不同:</p>

<p>logging.conf</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">[loggers]
keys = root, foo, bar

[handlers]
keys = root, foo, bar

[formatters]
keys = root, foo, bar

[logger_root]
level=DEBUG
handlers=root

[logger_foo]
level=DEBUG
handlers=FileHandler
qualname=foo
propagate=0

[logger_bar]
level=DEBUG
handlers=RotatingFileHandler
qualname=bar
propagate=0

[handler_root]
class=StreamHandler
level=INFO
formatter=root
args=(sys.stdout,)

[handler_foo]
class=FileHandler
level=WARNING
formatter=foo
args=(&#39;foo.log&#39;, &#39;a&#39;)

[handler_bar]
class=handlers.RotatingFileHandler
level=DEBUG
formatter=bar
args=(&#39;bar.log&#39;, &#39;a&#39;, 20, 9)

[formatter_root]
format=simpleFormatter
datefmt=

[formatter_foo]
format=%(asctime)s %(name)s %(levelname)s %(message)s
datefmt=%Y-%m-%d %H-%M-%S
class=logging.Formatter

[formatter_bar]
format=%(asctime)s %(name)s %(levelname)s %(message)s
datefmt=%Y-%m-%d %H-%M-%S
class=logging.Formatter
</code></pre></div>
<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>

<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fileConfig</span><span class="p">(</span><span class="s">&#39;cfg.ini&#39;</span><span class="p">)</span> 
 
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span> 
<span class="n">logger_foo</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span> 
<span class="n">logger_bar</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">)</span> 
 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span> 
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;num: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> 
    <span class="n">logger_foo</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;num: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> 
    <span class="n">logger_bar</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;num: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> 
</code></pre></div>

<p>需要注意的是加载配置信息时，之前创建的 logger 会失效。</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>

<span class="n">logger_foo</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># logger_foo 被创建之后加载了配置信息</span>
<span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">dict_config</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">INFO</span><span class="p">(</span><span class="s">&#39;logger is not work!&#39;</span><span class="p">)</span>
</code></pre></div>

<p>最好的做法是在需要 logger 的时候才去获取。</p>

</div>

<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"tonsh"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->

</div>


        <div class="footer">
          <p>
            &copy; 2013 - 2013 tonsh&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/about">About</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/links">Links</a>&nbsp;&nbsp;|&nbsp;&nbsp;Powered by <a href="http://github.com/mojombo/jekyll" target="_blank">Jekyll</a>&<a href="http://pages.github.com" target="_blank">GitHub</a>
          </p>
        </div>
      </div>
    </body>
</html>
