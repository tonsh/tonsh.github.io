<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Mysql 同步备份方案</title>
        <meta name="viewport" content="width=device-width" />

        <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.min.css" />
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css" />
        
        <!-- RSS -->
        <link rel="alternate" type="application/rss+xml" title="Tonsh's Blog" href="http://tonsh.github.io/feed.xml" />

    </head>

    <body>
      <div class="site">
        <div class="header">
  <h1 class="title"><a href="/">Tonsh's Blog</a></h1>
</div>

<!--<div class="nav">
  <div class="nav-block">
      <a class="item" href="/">Home</a>
  </div>
</div>
-->

<div class="site-content">
<h2 class="post-title">Mysql 同步备份方案</h2>
<p class="meta">28 Nov 2013</p>

<div class="post">
<pre class="reference">
这是一篇以前在自己博客写的旧文章，最近考虑要不要关闭以前的博客(好久没被更新过了 >_<)。 所以挑了一篇想留下的搬过来。
</pre>

<p>应用程序上线后,不得不考虑的一个问题便是数据库备份及实现生成环境与开发环境的数据库同步。下面是我想到的一个解决方案：开发环境每天凌晨 3 点触发线上的 Mysql 备份脚本，然后将线上的备份文件拷贝到本地,并导入开发 Mysql 数据库。</p>

<p>线上的备份脚本 /home/youremote/shell/mysql_make_backup.sh</p>

<div class="highlight"><pre><code class="bash"><span class="nv">date</span><span class="o">=</span><span class="sb">`</span>date + %Y%m%d<span class="sb">`</span>
<span class="nv">dir</span><span class="o">=</span>/home/youremote/mysqlbk
<span class="nv">file</span><span class="o">=</span><span class="k">${</span><span class="nv">dir</span><span class="k">}</span>/mysqlbk.<span class="k">${</span><span class="nv">date</span><span class="k">}</span>.sql.bz2
 
mysqldump --add-drop-table -u username -ppassword databasename <span class="p">|</span> bzip2 &gt; <span class="k">${</span><span class="nv">file</span><span class="k">}</span>
 
<span class="c">#删除7天前的备份文件</span>
find <span class="k">${</span><span class="nv">dir</span><span class="k">}</span> -mtime +7 -exec rm -f <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div>

<p>开发环境下的定时脚本 /home/yourlocal/shell/mysql_make_import.sh</p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>
 
<span class="nv">date</span><span class="o">=</span><span class="sb">`</span>date + %Y%m%d<span class="sb">`</span>
<span class="nv">filename</span><span class="o">=</span>mysqlbk.<span class="k">${</span><span class="nv">date</span><span class="k">}</span>.sql.bz2
<span class="nv">remoteFile</span><span class="o">=</span>/home/youremote/mysqlbk/<span class="k">${</span><span class="nv">filename</span><span class="k">}</span>
<span class="nv">localdir</span><span class="o">=</span>/home/yourlocal/import
 
<span class="c">#运行线上的备份脚本</span>
ssh tonsh@tonsh.net /home/youremote/shell/mysql_make_backup.sh
<span class="c">#将备份文件拷贝到本地</span>
scp tonsh@tonsh.net:<span class="k">${</span><span class="nv">remoteFile</span><span class="k">}</span> <span class="k">${</span><span class="nv">localdir</span><span class="k">}</span>
<span class="c">#更新本地 mysql</span>
bunzip2 &lt; <span class="k">${</span><span class="nv">localdir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">filename</span><span class="k">}</span> <span class="p">|</span> mysql -uusername -ppassword databasename
</code></pre></div>

<p>加入定时任务，新建文件cronfile（或 crontab -e), 加入一下内容：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">0 3 * * * /home/yourlocal/shell/mysql_make_import.sh
</code></pre></div>
<p>运行 crontab</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">crontab cronfile
crontab -l
    0 3 * * * /home/yourlocal/shell/mysql_make_import.sh
</code></pre></div>
<p>定时任务每天凌晨3点会触发开发环境的 shell 脚本 mysql_make_import.sh, 该脚本先触发远程服务器(生成环境) Mysql 备份脚本; 然后将远程服务器的备份文件通过 scp 保存至本地(开发环境); 最后将保存后的备份文件导入开发数据库。</p>

<p>这样既保证了生成环境 Mysql 数据库的备份，也能使开发环境数据同步。当然，如果开发环境没必要与生成环境数据同步，可省去数据导入的步骤。</p>

</div>

<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"tonsh"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->

</div>


        <div class="footer">
          <p>
            &copy; 2013 - 2013 tonsh&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/about">About</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="/links">Links</a>&nbsp;&nbsp;|&nbsp;&nbsp;Powered by <a href="http://github.com/mojombo/jekyll" target="_blank">Jekyll</a>&<a href="http://pages.github.com" target="_blank">GitHub</a>
          </p>
        </div>
      </div>
    </body>
</html>
